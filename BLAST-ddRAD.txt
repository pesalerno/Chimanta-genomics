########  finally remove contaminants from blast  #######

# first generate the list of tag ids to use for the blast query.. this is the fist part of the locus name (i.e 3 in 3_43)
tags=as.numeric(t(as.data.frame(strsplit(as.vector(Bbi.c@loc.names), "_"))[1,]))
tags.u = unique(tags)  #1479 unique tags
write.table(tags.u,"TagList.txt", row.names=F, col.names=F, eol="\n")

# now use the TagList.txt file to filter out the sequences from the stacks catalog to make a fasta file in perl/bash

      # in Ubuntu terminal
      # you will need to edit the eol markers before running the script
      perl ~/scripts/vlookup.pl \
      '/media/sf_UbuntuShare/Rwork/Bbi_141201/TagList.txt' \
      '/home/nick/.gvfs/nick on zamudiodrobo5n/Projects/EVOTRAC_RADseq/Bbi/StacksWork_Bbi/Bbi_stacks_M3_n2/batch_1.catalog.tags.tsv' \
      > Bbi_seqs.tab
      
      # then convert that file from tab to fasta  
      perl ~/scripts/PipeMeta_v0.44/FastaFormat.pl -i Bbi_seqs.tab -o Bbi_seqs.fas -p -l 100
      
      # this fasta file can be use as the blast template
      mv Bbi_seqs* '/media/sf_UbuntuShare/BlastWork/Bbi_BlastWork/Bbi_seqs.tab'
      
      # in cygwin terminal
      #  to get blast to work from anywhere add Blast binaries and the BlastDB location to the PATH variable before runnig the blast comd
      export PATH=$PATH:/cygdrive/c/Users/Nick/Documents/UbuntuShare/BlastDB/all
      export PATH=$PATH:/cygdrive/c/Program\ Files/NCBI/blast-2.2.29+/bin
      
      cd /cygdrive/c/Users/Nick/Documents/UbuntuShare/BlastWork/Bbi_BlastWork/
        
        # if you get an error with this command try retyping in into the terminal... copy/paste can be quirky with blast commands
        blastx -num_threads 7 \
      -query Bbi_seqs.fas \
      -db nr \
      -out Bbi_seqs.blastx.out \
      -evalue 0.0001 -max_target_seqs 1 -outfmt '6 std sskingdoms sblastnames scomnames sscinames staxids stitle'
      # took ~3h

# blast hits to potential contaminants
702
1475
3294
3665
3993

BlastHits=read.clipboard(header=F)
BlastHits=unique(BlastHits[,1])
temp=unlist(strsplit(Bbi.c@loc.names,"_"))
temp=temp[seq(1,length(temp), 2)]
Hits=BlastHits[which(BlastHits%in%temp)]
blk.list=names(temp[which(temp%in%Hits)])
blk.coords=which(temp%in%Hits)
Bbi.c =Bbi.c[,loc=names(Bbi.c@loc.names[-blk.coords])]

#      @ind.names: vector of  502 individual names
#      @loc.names: vector of  1315 locus names
